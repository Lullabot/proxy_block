name: CI

on:
  push:
    branches: [main, '*.x']
  pull_request:
  schedule:
    - cron: '0 6 * * *'

env:
  DRUPAL_ROOT: drupal-root
  MODULE_NAME: ${{ github.event.repository.name }}
  MODULE_PATH: web/modules/contrib/${{ github.event.repository.name }}
  # Composer CI configuration
  COMPOSER_NO_INTERACTION: '1'
  COMPOSER_ALLOW_SUPERUSER: '1'
  # PHPUnit test configuration
  SIMPLETEST_DB: 'mysql://drupal:drupal@127.0.0.1:3306/drupal'
  SIMPLETEST_BASE_URL: 'http://127.0.0.1:8080'
  BROWSERTEST_OUTPUT_DIRECTORY: '/tmp/simpletest_output'
  MINK_DRIVER_ARGS_WEBDRIVER: '["chrome", {"browserName":"chrome","goog:chromeOptions":{"args":["--disable-gpu","--headless","--no-sandbox","--disable-dev-shm-usage"]}}, "http://127.0.0.1:9515"]'
  SYMFONY_DEPRECATIONS_HELPER: 'ignoreFile=${{ github.workspace }}/drupal-root/.deprecation-ignore.txt'

jobs:
  # Combined Drupal CI Job - Composer, PHPStan, and PHPUnit
  test:
    name: 'üß™ Drupal (${{ matrix.drupal-core }}, PHP ${{ matrix.php-version }})'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        drupal-core: ['10', '11']
        php-version: ['8.3']
        db-version: ['10.9']

    services:
      mariadb:
        image: mariadb:${{ matrix.db-version }}
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: drupal
          MYSQL_USER: drupal
          MYSQL_PASSWORD: drupal
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: gd, pdo_mysql, mbstring, xml, opcache, mysql, curl, zip, sockets
          tools: composer:v2
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer --global config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ matrix.drupal-core }}-${{ matrix.php-version }}-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-composer-${{ matrix.drupal-core }}-${{ matrix.php-version }}-
            ${{ runner.os }}-composer-

      - name: Create Drupal project
        run: composer create-project drupal/recommended-project:^${{ matrix.drupal-core }} ${{ env.DRUPAL_ROOT }} --no-interaction

      - name: Configure Drupal project
        working-directory: ${{ env.DRUPAL_ROOT }}
        run: |
          # Configure platform PHP version
          composer config platform.php ${{ matrix.php-version }}

          # Add essential development dependencies for Drupal testing
          composer require --dev --no-interaction \
            drupal/core-dev \
            drupal/coder \
            drush/drush \
            phpstan/phpstan \
            mglaman/phpstan-drupal \
            phpstan/phpstan-deprecation-rules

          composer dump-autoload

      - name: Checkout module
        uses: actions/checkout@v4
        with:
          path: ${{ env.DRUPAL_ROOT }}/${{ env.MODULE_PATH }}

      - name: Setup module
        working-directory: ${{ env.DRUPAL_ROOT }}/${{ env.MODULE_PATH }}
        run: |
          composer config --no-plugins allow-plugins.phpstan/extension-installer true
          composer --dev --no-interaction --no-progress install

      - name: Run PHPCS
        working-directory: ${{ env.DRUPAL_ROOT }}/${{ env.MODULE_PATH }}
        run: |
          composer run-script lint:check

      - name: Run PHPStan
        working-directory: ${{ env.DRUPAL_ROOT }}
        run: |
          php vendor/bin/phpstan.phar \
            --configuration=${{ env.MODULE_PATH }}/phpstan.neon

      - name: Install Drupal
        working-directory: ${{ env.DRUPAL_ROOT }}
        run: |
          php vendor/bin/drush site-install standard \
            --db-url=mysql://drupal:drupal@127.0.0.1:3306/drupal \
            --account-name=admin \
            --account-pass=admin \
            --yes

      - name: Enable module
        working-directory: ${{ env.DRUPAL_ROOT }}
        run: |
          php vendor/bin/drush cache:rebuild
          php vendor/bin/drush pm:enable ${{ env.MODULE_NAME }} --yes

      - name: Copy deprecation ignore file
        working-directory: ${{ env.DRUPAL_ROOT }}
        run: cp web/core/.deprecation-ignore.txt .

      - name: Create artifact directory for HTML output
        run: |
          # Create the directory specified by BROWSERTEST_OUTPUT_DIRECTORY
          mkdir -p /tmp/simpletest_output
          chmod 777 /tmp/simpletest_output

          # Also create the default browser output directory that tests use
          mkdir -p ${{ env.DRUPAL_ROOT }}/sites/simpletest/browser_output
          chmod 777 ${{ env.DRUPAL_ROOT }}/sites/simpletest/browser_output

          echo "Created HTML output directories:"
          ls -la /tmp/simpletest_output
          ls -la ${{ env.DRUPAL_ROOT }}/sites/simpletest/browser_output

      - name: Setup Chrome and ChromeDriver (for functional-javascript tests)
        uses: browser-actions/setup-chrome@latest

      - name: Start ChromeDriver
        run: |
          # ChromeDriver is already installed with Chrome
          chromedriver --port=9515 &
          sleep 2

          # Health check for ChromeDriver
          retries=10
          count=0
          until curl -s http://127.0.0.1:9515/status > /dev/null; do
            count=$((count+1))
            if [ ${count} -gt ${retries} ]; then
              echo "ChromeDriver failed to start after ${retries} retries."
              exit 1
            fi
            echo "Waiting for ChromeDriver... (Attempt ${count})"
            sleep 1
          done
          echo "ChromeDriver is ready!"

      - name: Start web server for functional tests
        working-directory: ${{ env.DRUPAL_ROOT }}
        run: |
          php -S 127.0.0.1:8080 -t web > /dev/null 2>&1 &
          sleep 2

      - name: Run Unit tests
        working-directory: ${{ env.DRUPAL_ROOT }}
        run: php vendor/bin/phpunit \
          --configuration ${{ github.workspace }}/${{ env.DRUPAL_ROOT }}/web/core/phpunit.xml.dist \
          ${{ env.MODULE_PATH }}/tests/src/Unit

      - name: Run Kernel tests
        working-directory: ${{ env.DRUPAL_ROOT }}
        run: php vendor/bin/phpunit \
          --configuration ${{ github.workspace }}/${{ env.DRUPAL_ROOT }}/web/core/phpunit.xml.dist \
          ${{ env.MODULE_PATH }}/tests/src/Kernel

      - name: Run Functional tests
        id: functional-tests
        working-directory: ${{ env.DRUPAL_ROOT }}
        run: |
          echo "Starting functional tests with HTML output enabled..."
          echo "BROWSERTEST_OUTPUT_DIRECTORY=$BROWSERTEST_OUTPUT_DIRECTORY"
          echo "Directory contents before test:"
          ls -la /tmp/simpletest_output/ || echo "Directory is empty"

          # Check if HtmlOutputLogger extension is working
          php -r "
            \$directory = '/tmp/simpletest_output';
            \$tempFile = tempnam(\$directory, 'browser_output_test_');
            if (\$tempFile) {
              echo 'tempnam() works: ' . \$tempFile . PHP_EOL;
              unlink(\$tempFile);
            } else {
              echo 'tempnam() failed' . PHP_EOL;
            }
          "
          
          # Check PHPUnit extensions and HTML output settings
          echo "Checking PHPUnit configuration:"
          php vendor/bin/phpunit \
            --configuration ${{ github.workspace }}/${{ env.DRUPAL_ROOT }}/web/core/phpunit.xml.dist \
            --list-extensions 2>/dev/null | grep -i html || echo "No HTML extension found"
          
          echo "Environment variables:"
          echo "BROWSERTEST_OUTPUT_DIRECTORY=$BROWSERTEST_OUTPUT_DIRECTORY"
          echo "BROWSERTEST_OUTPUT_FILE=\${BROWSERTEST_OUTPUT_FILE:-unset}"
          
          # Test if HTML output would work by running the core test that's designed to generate HTML
          echo "Testing HTML output generation with core test:"
          php vendor/bin/phpunit \
            --configuration ${{ github.workspace }}/${{ env.DRUPAL_ROOT }}/web/core/phpunit.xml.dist \
            --filter="FunctionalTestDebugHtmlOutputHelperTest::testCreateFunctionalTestDebugHtmlOutput" \
            web/core/tests/Drupal/FunctionalTests/Test/ || echo "Core HTML test not available"

          php vendor/bin/phpunit \
            --configuration ${{ github.workspace }}/${{ env.DRUPAL_ROOT }}/web/core/phpunit.xml.dist \
            ${{ env.MODULE_PATH }}/tests/src/Functional

      - name: Check HTML output after functional tests
        if: always()
        run: |
          echo "Directory contents after functional tests:"
          echo "=== /tmp/simpletest_output/ ==="
          ls -la /tmp/simpletest_output/ || echo "Directory is empty"
          find /tmp/simpletest_output/ -name "*.html" -type f | head -10 || echo "No HTML files found in /tmp/simpletest_output/"

          echo "=== ${{ env.DRUPAL_ROOT }}/sites/simpletest/browser_output/ ==="
          ls -la ${{ env.DRUPAL_ROOT }}/sites/simpletest/browser_output/ || echo "Directory is empty"
          find ${{ env.DRUPAL_ROOT }}/sites/simpletest/browser_output/ -name "*.html" -type f | head -10 || echo "No HTML files found in sites/simpletest/browser_output/"

      - name: Upload HTML artifacts on Functional test failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: functional-test-html-output-drupal-${{ matrix.drupal-core }}-php-${{ matrix.php-version }}
          path: |
            /tmp/simpletest_output/
            ${{ env.DRUPAL_ROOT }}/sites/simpletest/browser_output/
          retention-days: 14
          if-no-files-found: ignore

      - name: Run FunctionalJavascript tests
        id: functional-js-tests
        working-directory: ${{ env.DRUPAL_ROOT }}
        run: |
          echo "Starting FunctionalJavascript tests with HTML output enabled..."
          echo "Directory contents before JS tests:"
          ls -la /tmp/simpletest_output/ || echo "Directory is empty"
          php vendor/bin/phpunit \
            --configuration ${{ github.workspace }}/${{ env.DRUPAL_ROOT }}/web/core/phpunit.xml.dist \
            ${{ env.MODULE_PATH }}/tests/src/FunctionalJavascript

      - name: Check HTML output after JS tests
        if: always()
        run: |
          echo "Directory contents after JS tests:"
          echo "=== /tmp/simpletest_output/ ==="
          ls -la /tmp/simpletest_output/ || echo "Directory is empty"
          find /tmp/simpletest_output/ -name "*.html" -type f | head -10 || echo "No HTML files found in /tmp/simpletest_output/"

          echo "=== ${{ env.DRUPAL_ROOT }}/sites/simpletest/browser_output/ ==="
          ls -la ${{ env.DRUPAL_ROOT }}/sites/simpletest/browser_output/ || echo "Directory is empty"
          find ${{ env.DRUPAL_ROOT }}/sites/simpletest/browser_output/ -name "*.html" -type f | head -10 || echo "No HTML files found in sites/simpletest/browser_output/"

      - name: Upload HTML artifacts on FunctionalJavascript test failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: functional-js-test-html-output-drupal-${{ matrix.drupal-core }}-php-${{ matrix.php-version }}
          path: |
            /tmp/simpletest_output/
            ${{ env.DRUPAL_ROOT }}/sites/simpletest/browser_output/
          retention-days: 14
          if-no-files-found: ignore

  code-quality:
    name: 'üîç Code Quality (ESLint, Stylelint, CSpell)'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Node.js dependencies
        run: npm install --include=dev

      - name: Run Code Quality Checks
        run: |
          npm run check
